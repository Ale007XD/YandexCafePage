<!DOCTYPE html>
<html>
<head>
    <title>Поиск кафе</title>
    <meta charset="utf-8">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=2a0dabb2-b68f-4c3d-b1b6-eab7c383104f&lang=ru_RU"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .info-window {
            max-width: 250px; /* Увеличил ширину информационного окна */
        }
        /* Стили для кнопки */
        .info-window button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let userPlacemark; // Для хранения placemark пользователя
        let map; // Для доступа к карте из buildRoute

        function init() {
            map = new ymaps.Map('map', {
                center: [55.75, 37.62],
                zoom: 14
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setCenter(userLocation);

                        userPlacemark = new ymaps.Placemark(userLocation, {}, {
                            iconColor: 'blue' // Синий цвет для placemark пользователя
                        });
                        map.geoObjects.add(userPlacemark);

                        searchCafes(userLocation);
                    },
                    error => {
                        let errorMessage;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Доступ к геолокации запрещен пользователем.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Не удалось получить данные о местоположении.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Превышено время ожидания получения местоположения.";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = "Неизвестная ошибка геолокации.";
                                break;
                        }
                        alert("Ошибка геолокации: " + errorMessage);
                        // Возможность предложить пользователю выбрать местоположение на карте
                    }
                );
            } else {
                alert('Ваш браузер не поддерживает геолокацию.');
            }
        }

        function searchCafes(location) {
            ymaps.geocode(location, {
                kind: 'cafe',
                results: 50
            }).then(res => {
                const cafes = res.geoObjects.toArray()
                    .filter(cafe => cafe.properties.get('name'))
                    .sort((a, b) => {
                        const ratingA = a.properties.get('rating') || 0;
                        const ratingB = b.properties.get('rating') || 0;
                        return ratingB - ratingA;
                    })
                    .slice(0, 10); // Увеличил количество отображаемых кафе

                cafes.forEach(cafe => {
                    const rating = cafe.properties.get('rating') || 'нет оценки';
                    const name = cafe.properties.get('name');
                    const address = cafe.properties.get('description');

                    const placemark = new ymaps.Placemark(cafe.geometry.getCoordinates(), {
                        balloonContent: `
                            <div class="info-window">
                                <h3>${name}</h3>
                                <p>${address}</p>
                                <p>Рейтинг: ${rating}</p>
                                <button onclick="buildRoute(${cafe.geometry.getCoordinates()})">
                                    Построить маршрут
                                </button>
                            </div>
                        `
                    });

                    map.geoObjects.add(placemark);
                });
            }).catch(error => {
                console.error("Ошибка поиска кафе:", error);
                alert("Произошла ошибка при поиске кафе. Попробуйте позже.");
            });
        }

        function buildRoute(targetCoordinates) {
            ymaps.route([
                userPlacemark.geometry.getCoordinates(), // Используем сохраненный placemark пользователя
                targetCoordinates
            ], {
                // options for route
            }).then(route => {
                map.geoObjects.add(route);
            }).catch(error => {
                console.error("Ошибка построения маршрута:", error);
                alert("Произошла ошибка при построении маршрута. Попробуйте позже.");
            });
        }

        ymaps.ready(init);
    </script>
</body>
</html>
